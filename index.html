<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
    />
    <title>Spinning Coin with Shop</title>
    <script src="/public/phaser.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      #game-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <div id="game-container"></div>
    <script>
      // 游戏配置常量
      const GAME_CONFIG = {
        WIDTH: 600,
        SHOP_WIDTH: 200,
        HEIGHT: 600,
        BACKGROUND_COLOR: "#52c41a",
        SHOP_COLOR: 0xfa8c16,
        COIN_TYPES: {
          COPPER: {
            name: "copper",
            basePrice: 10,
            value: 1,
          },
          SILVER: {
            name: "silver",
            basePrice: 100,
            value: 10,
          },
          GOLD: {
            name: "gold",
            basePrice: 1000,
            value: 100,
          },
        },
        ANIMATION: {
          SPIN_FRAME_RATE: 18,
          FLASH_FRAME_RATE: 12,
          SPIN_DURATION: 500,
          FLASH_DURATION: 2000,
        },
      };

      // 游戏状态管理
      class GameState {
        constructor() {
          this.score = this.loadScore();
          this.coins = this.loadCoins();
          this.saveState();
        }

        loadScore() {
          const cacheScore = Number(localStorage.getItem("score"));
          return Number.isNaN(cacheScore) ? 0 : cacheScore;
        }

        loadCoins() {
          try {
            const cacheCoins = JSON.parse(localStorage.getItem("coins"));
            return cacheCoins && Array.isArray(cacheCoins) ? cacheCoins : [];
          } catch (error) {
            console.warn("Failed to load coins from localStorage:", error);
            return [];
          }
        }

        saveState() {
          localStorage.setItem("score", this.score);
          localStorage.setItem("coins", JSON.stringify(this.coins));
        }

        addCoin(coin) {
          this.coins.push(coin);
          this.saveState();
        }

        setScore(value) {
          this.score = value;
          this.saveState();
        }
      }

      // 游戏主类
      class CoinGame {
        constructor() {
          this.gameState = new GameState();
          this.coinSprites = [];
          this.initGame();
        }

        initGame() {
          const totalWidth = GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH;

          this.config = {
            type: Phaser.AUTO,
            width: totalWidth,
            height: GAME_CONFIG.HEIGHT,
            backgroundColor: GAME_CONFIG.BACKGROUND_COLOR,
            parent: "game-container",
            scene: {
              preload: this.preload.bind(this),
              create: this.create.bind(this),
              update: this.update.bind(this),
            },
            audio: {
              disableWebAudio: false,
            },
          };

          this.game = new Phaser.Game(this.config);
        }

        preload() {
          const scene = this.game.scene.scenes[0];

          // 加载硬币精灵图
          Object.values(GAME_CONFIG.COIN_TYPES).forEach((coinType) => {
            scene.load.spritesheet(
              `${coinType.name}Coin`,
              `public/${
                coinType.name.charAt(0).toUpperCase() + coinType.name.slice(1)
              }CoinSpin.png`,
              { frameWidth: 16, frameHeight: 16 }
            );
            scene.load.spritesheet(
              `${coinType.name}CoinFlash`,
              `public/${
                coinType.name.charAt(0).toUpperCase() + coinType.name.slice(1)
              }CoinFlash.png`,
              { frameWidth: 16, frameHeight: 16 }
            );
          });

          scene.load.audio("spinSound", "public/coin_spin.mp3");
        }

        create() {
          const scene = this.game.scene.scenes[0];

          // 创建商店背景
          this.createShopBackground(scene);

          // 创建积分显示
          this.scoreText = this.createScoreText(scene);

          // 创建购买按钮
          this.createShopButtons(scene);

          // 创建动画
          this.createAnimations(scene);

          // 创建硬币
          this.createCoins(scene);

          // 加载音效
          this.spinSound = scene.sound.add("spinSound", { volume: 0.7 });

          // 更新按钮状态
          this.updateButtons();
        }

        createShopBackground(scene) {
          scene.add
            .rectangle(
              GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH / 2,
              GAME_CONFIG.HEIGHT / 2,
              GAME_CONFIG.SHOP_WIDTH,
              GAME_CONFIG.HEIGHT,
              GAME_CONFIG.SHOP_COLOR
            )
            .setOrigin(0.5);
        }

        createScoreText(scene) {
          return scene.add
            .text(
              GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH - 20,
              20,
              `${this.gameState.score}$`,
              {
                fontSize: "24px",
                color: "#fff",
                fontWeight: "bold",
              }
            )
            .setOrigin(1, 0);
        }

        createShopButtons(scene) {
          const buttonYPositions = [
            GAME_CONFIG.HEIGHT - 160,
            GAME_CONFIG.HEIGHT - 110,
            GAME_CONFIG.HEIGHT - 60,
          ];

          this.shopButtons = {};

          Object.values(GAME_CONFIG.COIN_TYPES).forEach((coinType, index) => {
            const button = scene.add
              .text(GAME_CONFIG.WIDTH + 10, buttonYPositions[index], "", {
                fontSize: "16px",
                color: "#fff",
                padding: { x: 10, y: 8 },
                fixedWidth: GAME_CONFIG.SHOP_WIDTH - 20,
                align: "center",
              })
              .setOrigin(0)
              .setInteractive({ useHandCursor: true })
              .on("pointerdown", () => this.buyCoin(coinType));

            this.shopButtons[coinType.name] = button;
          });
        }

        createAnimations(scene) {
          Object.values(GAME_CONFIG.COIN_TYPES).forEach((coinType) => {
            // 旋转动画
            scene.anims.create({
              key: `${coinType.name}Spin`,
              frames: scene.anims.generateFrameNumbers(`${coinType.name}Coin`, {
                start: 0,
                end: 5,
              }),
              frameRate: GAME_CONFIG.ANIMATION.SPIN_FRAME_RATE,
              repeat: -1,
            });

            // 闪光动画
            scene.anims.create({
              key: `${coinType.name}Flash`,
              frames: scene.anims.generateFrameNumbers(
                `${coinType.name}CoinFlash`,
                {
                  start: 0,
                  end: 6,
                }
              ),
              frameRate: GAME_CONFIG.ANIMATION.FLASH_FRAME_RATE,
              repeat: 0,
            });
          });
        }

        createCoins(scene) {
          // 如果没有硬币，创建一个默认的铜币
          if (this.gameState.coins.length === 0) {
            this.gameState.addCoin({
              type: GAME_CONFIG.COIN_TYPES.COPPER.name,
              value: GAME_CONFIG.COIN_TYPES.COPPER.value,
              x: GAME_CONFIG.WIDTH / 2,
              y: GAME_CONFIG.HEIGHT / 2,
            });
          }

          // 创建所有硬币精灵
          this.gameState.coins.forEach((coinData) => {
            this.createCoinSprite(scene, coinData);
          });
        }

        createCoinSprite(scene, coinData) {
          const coin = scene.add.sprite(
            coinData.x,
            coinData.y,
            `${coinData.type}Coin`
          );
          coin.setInteractive({ useHandCursor: true });
          coin.setScale(1.5); // 稍微放大硬币使其更易点击

          // 存储硬币数据
          coin.coinData = coinData;
          coin.isSpinning = false;

          // 添加点击事件
          coin.on("pointerdown", () => this.spinCoin(coin));

          this.coinSprites.push(coin);
          return coin;
        }

        spinCoin(coin) {
          if (coin.isSpinning) return;

          const scene = this.game.scene.scenes[0];
          coin.isSpinning = true;

          // 播放音效
          this.spinSound.play();

          // 播放旋转动画
          coin.play(`${coin.coinData.type}Spin`);

          // 计算新位置
          const margin = 30;
          const offsetX = Phaser.Math.Between(-50, 50);
          const offsetY = Phaser.Math.Between(-50, 50);

          const targetX = Phaser.Math.Clamp(
            coin.x + offsetX,
            margin,
            GAME_CONFIG.WIDTH - margin
          );
          const targetY = Phaser.Math.Clamp(
            coin.y + offsetY,
            margin,
            GAME_CONFIG.HEIGHT - margin
          );

          // 移动动画
          scene.tweens.add({
            targets: coin,
            scaleX: 3,
            scaleY: 3,
            x: targetX,
            y: targetY,
            duration: GAME_CONFIG.ANIMATION.SPIN_DURATION,
            ease: "Quad.easeOut",
            onComplete: () => {
              // 缩放回原始大小
              scene.tweens.add({
                targets: coin,
                scaleX: 1.5,
                scaleY: 1.5,
                duration: GAME_CONFIG.ANIMATION.SPIN_DURATION,
                ease: "Quad.easeIn",
                onComplete: () => {
                  // 停止旋转，播放闪光
                  coin.stop();
                  if (Math.random() < 0.5) {
                    coin.play(`${coin.coinData.type}Flash`);

                    // 显示加分文本
                    this.showScoreText(scene, coin, coin.coinData.value);

                    // 更新分数
                    this.gameState.setScore(
                      this.gameState.score + coin.coinData.value
                    );
                    this.scoreText.setText(`${this.gameState.score}$`);

                    // 更新按钮状态
                    this.updateButtons();
                  } else {
                    this.showSorryText(scene, coin);
                  }

                  // 更新硬币位置
                  coin.coinData.x = targetX;
                  coin.coinData.y = targetY;
                  this.gameState.saveState();

                  // 重置旋转状态
                  coin.isSpinning = false;
                },
              });
            },
          });
        }

        showSorryText(scene, coin) {
          const Text = scene.add
            .text(coin.x, coin.y - 30, `反面没钱!`, {
              fontSize: "16px",
              fontWeight: "bold",
              color: "#000",
              stroke: "#fff",
              strokeThickness: 3,
            })
            .setOrigin(0.5);

          scene.tweens.add({
            targets: Text,
            alpha: 0,
            y: Text.y - 20,
            duration: GAME_CONFIG.ANIMATION.FLASH_DURATION,
            ease: "Cubic.easeOut",
            onComplete: () => Text.destroy(),
          });
        }

        showScoreText(scene, coin, value) {
          const plusText = scene.add
            .text(coin.x, coin.y - 30, `正面+${value}$!`, {
              fontSize: "16px",
              fontWeight: "bold",
              color: "#fff",
              stroke: "#000",
              strokeThickness: 3,
            })
            .setOrigin(0.5);

          scene.tweens.add({
            targets: plusText,
            alpha: 0,
            y: plusText.y - 20,
            duration: GAME_CONFIG.ANIMATION.FLASH_DURATION,
            ease: "Cubic.easeOut",
            onComplete: () => plusText.destroy(),
          });
        }

        buyCoin(coinType) {
          const price = this.calculatePrice(coinType);

          if (this.gameState.score >= price) {
            // 扣除分数
            this.gameState.setScore(this.gameState.score - price);
            this.scoreText.setText(`${this.gameState.score}$`);

            // 创建新硬币
            const x = Phaser.Math.Between(50, GAME_CONFIG.WIDTH - 50);
            const y = Phaser.Math.Between(50, GAME_CONFIG.HEIGHT - 50);

            const newCoin = {
              type: coinType.name,
              value: coinType.value,
              x,
              y,
            };

            this.gameState.addCoin(newCoin);
            this.createCoinSprite(this.game.scene.scenes[0], newCoin);

            // 更新按钮状态
            this.updateButtons();
          }
        }

        calculatePrice(coinType) {
          const count = this.gameState.coins.filter(
            (coin) => coin.type === coinType.name
          ).length;

          return coinType.basePrice * (count || 0.5);
        }

        updateButtons() {
          Object.values(GAME_CONFIG.COIN_TYPES).forEach((coinType) => {
            const button = this.shopButtons[coinType.name];
            const price = this.calculatePrice(coinType);

            button.setText(
              `购买${this.getCoinTypeName(coinType.name)}\n${price}$`
            );

            if (this.gameState.score >= price) {
              button.setInteractive({ useHandCursor: true });
              button.setColor("#fff");
              button.setBackgroundColor("#1890ff");
            } else {
              button.disableInteractive();
              button.setColor("#888");
              button.setBackgroundColor("#bfbfbf");
            }
          });
        }

        getCoinTypeName(type) {
          const names = {
            copper: "铜币",
            silver: "银币",
            gold: "金币",
          };
          return names[type] || type;
        }

        update() {
          // 可以在这里添加游戏循环逻辑
        }
      }

      // 初始化游戏
      new CoinGame();
    </script>
  </body>
</html>
