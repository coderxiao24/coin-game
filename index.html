<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
    />
    <title>幸运硬币</title>
    <link rel="icon" href="./favicon.ico" />
    <script src="./public/phaser.min.js"></script>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div id="game-container"></div>
    <div id="start-menu" style="display: none">
      <h1 class="menu-title">幸运硬币</h1>
      <div id="menu-buttons"></div>
    </div>
    <div id="loading-container" style="display: none">
      <h2 class="loading-title">加载中...</h2>
      <div class="loading-bar-container">
        <div class="loading-bar" id="loading-bar"></div>
      </div>
      <div class="loading-text" id="loading-text">0%</div>
    </div>
    <script>
      // 游戏配置常量
      const GAME_CONFIG = {
        WIDTH: 300,
        SHOP_WIDTH: 100,
        HEIGHT: 800,
        DOLLAR_COLOR: "#E39500",
        COIN_TYPES: {
          COPPER: {
            name: "copper",
            basePrice: 5,
            value: 1,
          },
          SILVER: {
            name: "silver",
            basePrice: 50,
            value: 10,
          },
          GOLD: {
            name: "gold",
            basePrice: 500,
            value: 100,
          },
        },
        HELPER: {
          basePrice: 50,
        },
        ANIMATION: {
          HELPER_FRAME_RATE: 12,
          SPIN_FRAME_RATE: 18,
          FLASH_FRAME_RATE: 12,
          SPIN_DURATION: 500,
          FLASH_DURATION: 2000,
        },
      };

      // 游戏状态管理
      class GameState {
        constructor() {
          this.score = this.loadScore();
          this.coins = this.loadCoins();
          this.helpers = this.loadHelpers();

          this.debouncedSave = this._debounce(() => {
            localStorage.setItem("score", String(this.score));
            localStorage.setItem("coins", JSON.stringify(this.coins));
            localStorage.setItem("helpers", JSON.stringify(this.helpers));
          }, 500);

          this.saveState();
        }

        _debounce(func, delay) {
          let timeoutId;
          return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
          };
        }

        loadScore() {
          const cacheScore = Number(localStorage.getItem("score"));
          return Number.isNaN(cacheScore) ? 0 : cacheScore;
        }

        loadCoins() {
          try {
            const cacheCoins = JSON.parse(localStorage.getItem("coins"));
            return cacheCoins && Array.isArray(cacheCoins) ? cacheCoins : [];
          } catch (error) {
            console.warn("Failed to load coins from localStorage:", error);
            return [];
          }
        }
        loadHelpers() {
          try {
            const cacheHelpers = JSON.parse(localStorage.getItem("helpers"));
            return cacheHelpers && Array.isArray(cacheHelpers)
              ? cacheHelpers
              : [];
          } catch (error) {
            console.warn("Failed to load helpers from localStorage:", error);
            return [];
          }
        }

        saveState() {
          this.debouncedSave();
        }

        addHelper(helper) {
          this.helpers.push(helper);
          this.saveState();
        }

        addCoin(coin) {
          this.coins.push(coin);
          this.saveState();
        }

        setScore(value) {
          this.score = value;
          this.saveState();
        }

        ensureSaved() {
          // 清除防抖定时器并立即保存
          this.debouncedSave = () => {}; // 重置防抖函数（可选）
          localStorage.setItem("score", String(this.score));
          localStorage.setItem("coins", JSON.stringify(this.coins));
          localStorage.setItem("helpers", JSON.stringify(this.helpers));
        }

        // 检查是否有游玩记录
        hasSaveData() {
          return (
            localStorage.getItem("score") !== null ||
            localStorage.getItem("coins") !== null ||
            localStorage.getItem("helpers") !== null
          );
        }

        // 重置游戏数据
        resetGame() {
          this.score = 0;
          this.coins = [];
          this.helpers = [];
          this.ensureSaved();
        }
      }

      // 游戏主类
      class CoinGame {
        constructor() {
          this.gameState = new GameState();
          this.coinSprites = [];
          this.helperSprites = [];
          this.showStartMenu();
        }

        showStartMenu() {
          const startMenu = document.getElementById("start-menu");
          const menuButtons = document.getElementById("menu-buttons");

          // 清空现有按钮
          menuButtons.innerHTML = "";

          // 检查是否有游玩记录
          const hasSaveData = this.gameState.hasSaveData();

          if (hasSaveData) {
            // 有游玩记录：显示继续游戏和重新开始选项
            const continueButton = document.createElement("button");
            continueButton.className = "menu-button success";
            continueButton.textContent = "继续游戏";
            continueButton.onclick = () => {
              this.hideStartMenu();
              this.initGame();
            };

            const restartButton = document.createElement("button");
            restartButton.className = "menu-button warning";
            restartButton.textContent = "重新开始";
            restartButton.onclick = () => {
              if (confirm("确定要重新开始吗？这将清除您当前的所有进度！")) {
                this.gameState.resetGame();
                this.hideStartMenu();
                this.initGame();
              }
            };

            menuButtons.appendChild(continueButton);
            menuButtons.appendChild(restartButton);
          } else {
            // 没有游玩记录：只显示开始游戏
            const startButton = document.createElement("button");
            startButton.className = "menu-button success";
            startButton.textContent = "开始游戏";
            startButton.onclick = () => {
              this.hideStartMenu();
              this.initGame();
            };

            menuButtons.appendChild(startButton);
          }

          startMenu.style.display = "flex";
        }

        hideStartMenu() {
          const startMenu = document.getElementById("start-menu");
          startMenu.style.display = "none";
        }

        showLoadingScreen() {
          const loadingContainer = document.getElementById("loading-container");
          loadingContainer.style.display = "flex";
        }

        hideLoadingScreen() {
          const loadingContainer = document.getElementById("loading-container");
          loadingContainer.style.display = "none";
        }

        updateLoadingProgress(progress, text) {
          const loadingBar = document.getElementById("loading-bar");
          const loadingText = document.getElementById("loading-text");

          loadingBar.style.width = `${progress}%`;
          loadingText.textContent = text || `${Math.round(progress)}%`;
        }

        initGame() {
          // 显示加载界面
          this.showLoadingScreen();
          this.updateLoadingProgress(10, "初始化游戏...");

          const totalWidth = GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH;

          this.config = {
            type: Phaser.AUTO,
            width: totalWidth,
            height: GAME_CONFIG.HEIGHT,
            parent: "game-container",
            scene: {
              preload: this.preload.bind(this),
              create: this.create.bind(this),
              update: this.update.bind(this),
            },
            audio: {
              disableWebAudio: false,
            },
            scale: {
              mode: Phaser.Scale.FIT,
              autoCenter: Phaser.Scale.CENTER_BOTH,
              parent: "game-container",
              width: totalWidth,
              height: GAME_CONFIG.HEIGHT,
            },
            physics: {
              default: "arcade",
              arcade: {
                gravity: { y: 0 },
                debug: false,
              },
            },
          };

          this.game = new Phaser.Game(this.config);

          window.addEventListener("beforeunload", () => {
            this.gameState.ensureSaved();
          });
        }

        preload() {
          const scene = this.game.scene.scenes[0];

          this.updateLoadingProgress(33, "加载图像资源...");

          scene.load.image("woodenFloor", "public/floors/wooden.png");
          scene.load.image("shopWoodenFloor", "public/floors/shopWooden.png");

          scene.load.spritesheet(`helper`, `public/helper.png`, {
            frameWidth: 48,
            frameHeight: 48,
          });

          // 加载硬币精灵图
          Object.values(GAME_CONFIG.COIN_TYPES).forEach((coinType) => {
            scene.load.spritesheet(
              `${coinType.name}Coin`,
              `public/${
                coinType.name.charAt(0).toUpperCase() + coinType.name.slice(1)
              }CoinSpin.png`,
              { frameWidth: 16, frameHeight: 16 }
            );
            scene.load.spritesheet(
              `${coinType.name}CoinFlash`,
              `public/${
                coinType.name.charAt(0).toUpperCase() + coinType.name.slice(1)
              }CoinFlash.png`,
              { frameWidth: 16, frameHeight: 16 }
            );
          });

          scene.load.once("complete", () => {
            this.updateLoadingProgress(66, "加载音频...");
            scene.load.audio("spinSound", "public/coin_spin.mp3");
            scene.load.audio("attackSound", "public/helper_attack.mp3");

            scene.load.once("complete", () => {
              this.spinSound = scene.sound.add("spinSound");
              this.attackSound = scene.sound.add("attackSound");

              this.updateLoadingProgress(100, "游戏准备就绪!");
              setTimeout(() => {
                this.hideLoadingScreen();
              }, 200);

              scene.load.audio("bgm", "public/bgm.mp3");

              scene.load.once("complete", () => {
                this.initBgm(scene);
              });
              // 重启加载器
              scene.load.start();
            });

            scene.load.start();
          });
        }

        initBgm(scene) {
          // 创建音效实例
          this.bgm = scene.sound.add("bgm", {
            loop: true,
            volume: 0.7, // 降低音量避免干扰
          });
          // 播放背景音乐
          this.bgm.play();
        }

        create() {
          const scene = this.game.scene.scenes[0];

          this.createGameBackground(scene);

          // 创建商店背景
          this.createShopBackground(scene);

          // 创建积分显示
          this.scoreText = this.createScoreText(scene);

          // 创建购买按钮
          this.createShopButtons(scene);

          // 创建动画
          this.createAnimations(scene);

          // 创建硬币
          this.createCoins(scene);
          this.createHelpers(scene);

          // 更新按钮状态
          this.updateButtons();
        }

        createGameBackground(scene) {
          const floor = scene.add.tileSprite(
            GAME_CONFIG.WIDTH / 2, // x 居中于游戏区域
            GAME_CONFIG.HEIGHT / 2, // y 居中
            GAME_CONFIG.WIDTH, // 宽度 = 游戏区宽度
            GAME_CONFIG.HEIGHT, // 高度 = 游戏区高度
            "woodenFloor" // 使用加载的纹理
          );
          floor.setOrigin(0.5, 0.5);
        }

        createShopBackground(scene) {
          const shopFloor = scene.add.tileSprite(
            GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH / 2,
            GAME_CONFIG.HEIGHT / 2,
            GAME_CONFIG.SHOP_WIDTH,
            GAME_CONFIG.HEIGHT,
            "shopWoodenFloor"
          );
          shopFloor.setOrigin(0.5);

          scene.add
            .text(GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH / 2, 24, `商店`, {
              fontSize: "24px",
              fontWeight: "bold",
              color: GAME_CONFIG.DOLLAR_COLOR,
              stroke: "#000000",
              strokeThickness: 4,
            })
            .setOrigin(0.5);
        }

        createScoreText(scene) {
          return scene.add
            .text(
              (GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH) / 2,
              24,
              `${this.gameState.score}$`,
              {
                fontSize: "24px",
                color: "#fff",
                stroke: "#000",
                strokeThickness: 4,
                fontWeight: "bold",
              }
            )
            .setOrigin(0.5);
        }

        createShopButtons(scene) {
          this.shopButtons = {};

          Object.values(GAME_CONFIG.COIN_TYPES).forEach((coinType, index) => {
            const button = scene.add
              .text(
                GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH / 2,
                70 + 70 * index,
                "",
                {
                  fontSize: "20px",
                  color: "#fff",
                  stroke: "#000",
                  strokeThickness: 3,
                  padding: { x: 4, y: 8 },
                  fixedWidth: GAME_CONFIG.SHOP_WIDTH - 20,
                  align: "center",
                }
              )
              .setOrigin(0.5)
              .setInteractive({ useHandCursor: true })
              .on("pointerdown", () => this.buyCoin(coinType));

            this.shopButtons[coinType.name] = button;
          });

          // 添加助手购买按钮
          this.helperButton = scene.add
            .text(GAME_CONFIG.WIDTH + GAME_CONFIG.SHOP_WIDTH / 2, 280, "", {
              fontSize: "20px",
              color: "#fff",
              stroke: "#000",
              strokeThickness: 3,
              padding: { x: 4, y: 4 },
              fixedWidth: GAME_CONFIG.SHOP_WIDTH - 20,
              align: "center",
            })
            .setOrigin(0.5)
            .setInteractive({ useHandCursor: true })
            .on("pointerdown", () => this.buyHelper());
        }

        createAnimations(scene) {
          Object.values(GAME_CONFIG.COIN_TYPES).forEach((coinType) => {
            // 旋转动画
            scene.anims.create({
              key: `${coinType.name}Spin`,
              frames: scene.anims.generateFrameNumbers(`${coinType.name}Coin`, {
                start: 0,
                end: 5,
              }),
              frameRate: GAME_CONFIG.ANIMATION.SPIN_FRAME_RATE,
              repeat: -1,
            });

            // 闪光动画
            scene.anims.create({
              key: `${coinType.name}Flash`,
              frames: scene.anims.generateFrameNumbers(
                `${coinType.name}CoinFlash`,
                {
                  start: 0,
                  end: 6,
                }
              ),
              frameRate: GAME_CONFIG.ANIMATION.FLASH_FRAME_RATE,
              repeat: 0,
            });
          });

          scene.anims.create({
            key: `helper-idle-down`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 0,
              end: 5,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: -1,
          });
          scene.anims.create({
            key: `helper-idle-right`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 6,
              end: 11,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: -1,
          });

          scene.anims.create({
            key: `helper-idle-up`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 12,
              end: 17,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: -1,
          });
          scene.anims.create({
            key: `helper-move-down`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 18,
              end: 23,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: -1,
          });
          scene.anims.create({
            key: `helper-move-right`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 24,
              end: 29,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: -1,
          });

          scene.anims.create({
            key: `helper-move-up`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 30,
              end: 35,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: -1,
          });

          scene.anims.create({
            key: `helper-attack-down`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 36,
              end: 39,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: 0,
          });
          scene.anims.create({
            key: `helper-attack-right`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 42,
              end: 45,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: 0,
          });
          scene.anims.create({
            key: `helper-attack-up`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 48,
              end: 51,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: 0,
          });
          scene.anims.create({
            key: `helper-death`,
            frames: scene.anims.generateFrameNumbers(`helper`, {
              start: 54,
              end: 56,
            }),
            frameRate: GAME_CONFIG.ANIMATION.HELPER_FRAME_RATE,
            repeat: 0,
          });
        }

        createHelpers(scene) {
          this.gameState.helpers.forEach((item) => {
            const helper = scene.physics.add.sprite(item.x, item.y, "helper");
            helper.setScale(2);
            helper.helperData = item;

            const animKey = `helper-idle-${
              helper.helperData.direction === "left"
                ? "right"
                : helper.helperData.direction || "down"
            }`;
            helper.play(animKey);
            if (helper.helperData.direction === "left") {
              helper.flipX = true;
            } else {
              helper.flipX = false;
            }

            this.helperSprites.push(helper);
          });
        }

        createCoins(scene) {
          // 如果没有硬币，创建一个默认的铜币
          if (this.gameState.coins.length === 0) {
            this.gameState.addCoin({
              type: GAME_CONFIG.COIN_TYPES.COPPER.name,
              value: GAME_CONFIG.COIN_TYPES.COPPER.value,
              x: GAME_CONFIG.WIDTH / 2,
              y: GAME_CONFIG.HEIGHT / 2,
            });
          }

          // 创建所有硬币精灵
          this.gameState.coins.forEach((coinData) => {
            this.createCoinSprite(scene, coinData);
          });
        }

        createCoinSprite(scene, coinData) {
          const coin = scene.add.sprite(
            coinData.x,
            coinData.y,
            `${coinData.type}Coin`
          );
          coin.setInteractive({ useHandCursor: true });
          coin.setScale(2); // 稍微放大硬币使其更易点击

          // 存储硬币数据
          coin.coinData = coinData;
          coin.isSpinning = false;

          // 添加点击事件
          coin.on("pointerdown", () => this.spinCoin(coin));

          this.coinSprites.push(coin);
          return coin;
        }

        spinCoin(coin) {
          if (coin.isSpinning) return;

          const scene = this.game.scene.scenes[0];
          coin.isSpinning = true;

          this.spinSound?.play();

          // 播放旋转动画
          coin.play(`${coin.coinData.type}Spin`);

          // 计算新位置
          const margin = 20;
          const offsetX = Phaser.Math.Between(-40, 40);
          const offsetY = Phaser.Math.Between(-80, 80);

          const targetX = Phaser.Math.Clamp(
            coin.x + offsetX,
            margin,
            GAME_CONFIG.WIDTH - margin
          );
          const targetY = Phaser.Math.Clamp(
            coin.y + offsetY,
            margin,
            GAME_CONFIG.HEIGHT - margin
          );

          // 移动动画
          scene.tweens.add({
            targets: coin,
            scaleX: 4,
            scaleY: 4,
            x: targetX,
            y: targetY,
            duration: GAME_CONFIG.ANIMATION.SPIN_DURATION,
            ease: "Quad.easeOut",
            onComplete: () => {
              // 缩放回原始大小
              scene.tweens.add({
                targets: coin,
                scaleX: 2,
                scaleY: 2,
                duration: GAME_CONFIG.ANIMATION.SPIN_DURATION,
                ease: "Quad.easeIn",
                onComplete: () => {
                  // 停止旋转，播放闪光
                  coin.stop();
                  coin.setFrame(0);
                  // 提高一些概率 防止玩家烦躁
                  if (Math.random() < 0.7) {
                    coin.play(`${coin.coinData.type}Flash`);

                    // 显示加分文本
                    this.showScoreText(scene, coin, coin.coinData.value);

                    // 更新分数
                    this.gameState.setScore(
                      this.gameState.score + coin.coinData.value
                    );
                    this.scoreText.setText(`${this.gameState.score}$`);

                    // 更新按钮状态
                    this.updateButtons();
                  } else {
                    this.showSorryText(scene, coin);
                  }
                  // 更新硬币位置
                  coin.coinData.x = targetX;
                  coin.coinData.y = targetY;
                  this.gameState.saveState();

                  // 重置旋转状态
                  coin.isSpinning = false;
                },
              });
            },
          });
        }

        showScoreText(scene, coin, value) {
          // 创建数值文本，设置为白色填充，黑色边框
          const valueText = scene.add
            .text(coin.x, coin.y - 30, `${value}`, {
              fontSize: "16px",
              fontWeight: "bold",
              color: "#ffffff", // 白色填充
              stroke: "#000000",
              strokeThickness: 4,
            })
            .setOrigin(0.5);

          // 创建货币符号文本，设置为黄色填充，黑色边框
          const dollarSign = scene.add
            .text(valueText.x + valueText.width / 2 + 4, coin.y - 30, `$`, {
              fontSize: "16px",
              fontWeight: "bold",
              color: GAME_CONFIG.DOLLAR_COLOR,
              stroke: "#000000",
              strokeThickness: 4,
            })
            .setOrigin(0.5);

          // 同时对两个文本应用动画效果
          scene.tweens.add({
            targets: [valueText, dollarSign],
            alpha: 0,
            y: valueText.y - 20,
            duration: GAME_CONFIG.ANIMATION.FLASH_DURATION,
            ease: "Cubic.easeOut",
            onComplete: () => {
              valueText.destroy();
              dollarSign.destroy();
            },
          });
        }

        showSorryText(scene, coin) {
          const Text = scene.add
            .text(coin.x, coin.y - 30, `反面没钱`, {
              fontSize: "16px",
              fontWeight: "bold",
              color: "#fff",
              stroke: "#000",
              strokeThickness: 4,
            })
            .setOrigin(0.5);

          scene.tweens.add({
            targets: Text,
            alpha: 0,
            y: Text.y - 20,
            duration: GAME_CONFIG.ANIMATION.FLASH_DURATION,
            ease: "Cubic.easeOut",
            onComplete: () => Text.destroy(),
          });
        }

        buyCoin(coinType) {
          const price = this.calculatePrice(coinType);

          if (this.gameState.score >= price) {
            // 扣除分数
            this.gameState.setScore(this.gameState.score - price);
            this.scoreText.setText(`${this.gameState.score}$`);

            // 创建新硬币
            const x = Phaser.Math.Between(50, GAME_CONFIG.WIDTH - 50);
            const y = Phaser.Math.Between(50, GAME_CONFIG.HEIGHT - 50);

            const newCoin = {
              type: coinType.name,
              value: coinType.value,
              x,
              y,
            };

            this.gameState.addCoin(newCoin);
            this.createCoinSprite(this.game.scene.scenes[0], newCoin);

            // 更新按钮状态
            this.updateButtons();
          }
        }

        buyHelper() {
          const price = this.calculateHelperPrice();

          if (this.gameState.score >= price) {
            // 扣除分数
            this.gameState.setScore(this.gameState.score - price);
            this.scoreText.setText(`${this.gameState.score}$`);

            // 创建新助手
            const x = Phaser.Math.Between(50, GAME_CONFIG.WIDTH - 50);
            const y = Phaser.Math.Between(50, GAME_CONFIG.HEIGHT - 50);

            const newHelper = {
              x,
              y,
              direction: "down", // 默认方向
            };

            this.gameState.addHelper(newHelper);

            // 创建助手精灵
            const scene = this.game.scene.scenes[0];
            const helper = scene.physics.add.sprite(x, y, "helper");
            helper.setScale(2);
            helper.helperData = newHelper;

            const animKey = `helper-idle-down`;
            helper.play(animKey);
            helper.flipX = false;

            this.helperSprites.push(helper);

            // 更新按钮状态
            this.updateButtons();
          }
        }

        calculatePrice(coinType) {
          const count = this.gameState.coins.filter(
            (coin) => coin.type === coinType.name
          ).length;

          return coinType.basePrice * (count || 0.5);
        }

        calculateHelperPrice() {
          const count = this.gameState.helpers.length;
          return GAME_CONFIG.HELPER.basePrice * (count || 0.5);
        }

        updateButtons() {
          Object.values(GAME_CONFIG.COIN_TYPES).forEach((coinType) => {
            const button = this.shopButtons[coinType.name];
            const price = this.calculatePrice(coinType);

            button.setText(`${this.getCoinTypeName(coinType.name)}\n${price}$`);

            if (this.gameState.score >= price) {
              button.setInteractive({ useHandCursor: true });
              button.setColor("#fff");
              button.setBackgroundColor("#52c41a");
            } else {
              button.disableInteractive();
              button.setColor("#888");
              button.setBackgroundColor("#bfbfbf");
            }
          });

          // 更新助手按钮
          const helperPrice = this.calculateHelperPrice();
          this.helperButton.setText(`助手\n${helperPrice}$`);

          if (this.gameState.score >= helperPrice) {
            this.helperButton.setInteractive({ useHandCursor: true });
            this.helperButton.setColor("#fff");
            this.helperButton.setBackgroundColor("#52c41a");
          } else {
            this.helperButton.disableInteractive();
            this.helperButton.setColor("#888");
            this.helperButton.setBackgroundColor("#bfbfbf");
          }
        }

        getCoinTypeName(type) {
          const names = {
            copper: "铜币",
            silver: "银币",
            gold: "金币",
          };
          return names[type] || type;
        }
        update() {
          // Step 1: 收集所有有效 helper（非疲劳状态）
          const availableHelpers = this.helperSprites.filter((helper) => {
            if (
              helper.helperData.isTired &&
              Date.now() - helper.helperData.isTired < 5000
            ) {
              // 处理疲劳动画（同原来逻辑）
              if (Date.now() - helper.helperData.isTired > 500) {
                const animKey = `helper-death`;
                if (helper.anims.currentAnim?.key !== animKey) {
                  helper.play(animKey);
                  helper.flipX = helper.helperData.direction === "left";
                }
              }
              return false; // 疲劳中，不参与分配
            }
            delete helper.helperData.isTired;
            return true;
          });

          const availableCoins = this.coinSprites.filter(
            (coin) => !coin.isSpinning
          );

          // Step 2: 构建所有可能的 (helper, coin, distance) 配对
          const pairs = [];
          for (const helper of availableHelpers) {
            for (const coin of availableCoins) {
              const dx = coin.x - helper.x;
              const dy = coin.y - helper.y;
              const dist = Math.sqrt(dx * dx + dy * dy);
              pairs.push({ helper, coin, dist, dx, dy });
            }
          }

          // Step 3: 按距离升序排序（最近的优先匹配）
          pairs.sort((a, b) => a.dist - b.dist);

          // Step 4: 贪心分配（确保一对一）
          const assignedHelpers = new Set();
          const assignedCoins = new Set();
          const assignments = new Map(); // helper → { coin, dx, dy, dist }

          for (const { helper, coin, dx, dy, dist } of pairs) {
            if (assignedHelpers.has(helper) || assignedCoins.has(coin)) {
              continue; // 已分配，跳过
            }
            assignedHelpers.add(helper);
            assignedCoins.add(coin);
            assignments.set(helper, { coin, dx, dy, dist });
          }

          // Step 5: 更新每个 helper 的行为
          this.helperSprites.forEach((helper) => {
            // 先处理疲劳中的 helper（已在 availableHelpers 过滤，但需保持动画）
            if (
              helper.helperData.isTired &&
              Date.now() - helper.helperData.isTired < 5000
            ) {
              // 动画已在上面处理过，这里可跳过或保留检查
              return;
            }

            const assignment = assignments.get(helper);
            if (assignment) {
              const { coin, dx, dy, dist } = assignment;

              // 确定方向
              if (Math.abs(dx) > Math.abs(dy)) {
                helper.helperData.direction = dx > 0 ? "right" : "left";
              } else {
                helper.helperData.direction = dy > 0 ? "down" : "up";
              }

              if (dist > 20) {
                // 移动
                const speed = 100;
                helper.setVelocity((dx / dist) * speed, (dy / dist) * speed);

                const animKey = `helper-move-${
                  helper.helperData.direction === "left"
                    ? "right"
                    : helper.helperData.direction
                }`;

                if (helper.anims.currentAnim?.key !== animKey) {
                  helper.play(animKey);
                  helper.flipX = helper.helperData.direction === "left";
                }
              } else {
                // 攻击
                const animKey = `helper-attack-${
                  helper.helperData.direction === "left"
                    ? "right"
                    : helper.helperData.direction
                }`;

                helper.setVelocity(0, 0);
                if (helper.anims.currentAnim?.key !== animKey) {
                  helper.play(animKey);
                  helper.flipX = helper.helperData.direction === "left";

                  this.attackSound?.play();

                  setTimeout(() => {
                    this.spinCoin(coin);
                  }, 100);

                  helper.helperData.isTired = Date.now();
                }
              }

              helper.helperData.x = helper.x;
              helper.helperData.y = helper.y;
            } else {
              const animKey = `helper-idle-${
                helper.helperData.direction === "left"
                  ? "right"
                  : helper.helperData.direction || "down"
              }`;
              if (helper.anims.currentAnim?.key !== animKey) {
                helper.play(animKey);
                if (helper.helperData.direction === "left") {
                  helper.flipX = true;
                } else {
                  helper.flipX = false;
                }
              }
              // 没有目标：停止
              helper.setVelocity(0, 0);
            }

            this.gameState.saveState();
          });
        }
      }

      // 初始化游戏
      new CoinGame();
    </script>
  </body>
</html>
